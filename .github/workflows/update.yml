name: OHA Direct Download

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch: 

jobs:
  download_oha:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Download OHA Data with curl
        run: |
          echo "Starte Download..."
          
          curl -v -L \
            -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
            -H "Accept: application/json, text/plain, */*" \
            -H "Accept-Encoding: gzip, deflate" \
            --compressed \
            --max-time 300 \
            --retry 5 \
            --retry-delay 10 \
            --retry-max-time 600 \
            -o cache_oha.json \
            "http://oha.to/mediaurl-catalog.json"
          
          SIZE=$(wc -c < cache_oha.json | tr -d ' ')
          echo "Download-Größe: $SIZE Bytes"
          
          if [ $SIZE -lt 1000000 ]; then
            echo "FEHLER: Datei zu klein ($SIZE Bytes)"
            echo "Inhalt:"
            head -n 50 cache_oha.json
            exit 1
          fi
          
          echo "✓ Download erfolgreich ($SIZE Bytes)"

      - name: Validiere JSON
        run: |
          echo "Validiere JSON..."
          
          if ! python3 -m json.tool cache_oha.json > /dev/null 2>&1; then
            echo "FEHLER: Ungültiges JSON"
            echo "Erste 1000 Zeichen:"
            head -c 1000 cache_oha.json
            exit 1
          fi
          
          ITEMS=$(python3 -c "import json; data=json.load(open('cache_oha.json')); print(len(data.get('items', [])))")
          echo "✓ JSON gültig - $ITEMS Items gefunden"
          
          if [ "$ITEMS" -lt 100 ]; then
            echo "WARNUNG: Weniger als 100 Items"
          fi

      - name: Push zum Repository
        run: |
          if [ -f cache_oha.json ]; then
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            git add cache_oha.json
            git diff --staged --quiet || git commit -m "Update OHA Data - $(date '+%Y-%m-%d %H:%M UTC')"
            git push
            echo "✓ Erfolgreich gepusht"
          else
            echo "FEHLER: cache_oha.json nicht gefunden"
            exit 1
          fi
