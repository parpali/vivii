name: OHA Force POST Update
on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

jobs:
  download_oha:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Download Full OHA Catalog
        run: |
          echo "Starte getarnten POST-Request..."
          
          # Wir fügen Accept-Encoding und Host hinzu, um die App exakt zu kopieren
          curl -X POST "http://oha.to/mediaurl-catalog.json" \
               -H "Host: oha.to" \
               -H "user-agent: MediaUrl/2" \
               -H "Accept-Encoding: gzip" \
               -H "Content-Type: application/json; charset=utf-8" \
               -H "Connection: Keep-Alive" \
               -d '{
                 "language": "de",
                 "region": "XX",
                 "catalogId": "iptv",
                 "id": "iptv",
                 "adult": false,
                 "search": "",
                 "sort": "",
                 "filter": {},
                 "cursor": null,
                 "clientVersion": "3.0.2"
               }' \
               --compressed \
               -o cache_oha.json

      - name: Check Dateigröße
        run: |
          SIZE=$(stat -c%s "cache_oha.json")
          echo "Dateigröße: $SIZE Bytes"
          # Da die Daten komprimiert (gzip) kommen, ist die Datei kleiner als 15MB, 
          # sollte aber deutlich über 50KB (51200 Bytes) liegen.
          if [ $SIZE -lt 100000 ]; then
            echo "FEHLER: Immer noch nur 50KB geladen. Server blockiert GitHub Action IP."
            exit 1
          fi

      - name: Push to Repo
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add cache_oha.json
          git commit -m "Update OHA Data (Force POST)" || exit 0
          git push
