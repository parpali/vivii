name: OHA POST Force Update

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch: 

jobs:
  download_oha:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Download Full OHA Catalog (POST Method)
        run: |
          echo "Starte Download mit POST-Request..."
          
          # Wir nutzen exakt die Header und den Body aus deiner Analyse
          curl -X POST "http://oha.to/mediaurl-catalog.json" \
               -H "user-agent: MediaUrl/2" \
               -H "Content-Type: application/json; charset=utf-8" \
               -d '{
                 "language": "de",
                 "region": "XX",
                 "catalogId": "iptv",
                 "id": "iptv",
                 "adult": false,
                 "search": "",
                 "sort": "",
                 "filter": {},
                 "cursor": null,
                 "clientVersion": "3.0.2"
               }' \
               -o cache_oha.json

      - name: Validierung der Dateigröße
        run: |
          FILESIZE=$(stat -c%s "cache_oha.json")
          echo "Dateigröße: $FILESIZE Bytes"
          
          # Die Datei muss deutlich größer als 50KB sein
          if [ $FILESIZE -lt 1000000 ]; then
            echo "FEHLER: Download unvollständig ($FILESIZE Bytes). POST-Request fehlgeschlagen."
            exit 1
          fi

      - name: Push zum Repository
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add cache_oha.json
          git commit -m "Update OHA Data (POST Method)" || exit 0
          git push
